name: .NET Build Pipeline

trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  dotnetVersion: '8.0.x'
  projectPath: 'src/**/*.csproj'

jobs:
  - job: BuildAndTest
    displayName: 'Build and Test .NET Application'
    timeoutInMinutes: 30
    steps:
      - checkout: self
        displayName: 'Checkout source code'

      - task: UseDotNet@2
        displayName: 'Install .NET $(dotnetVersion)'
        inputs:
          version: '$(dotnetVersion)'
          packageType: 'sdk'

      - task: DotNetCoreCLI@2
        displayName: 'Restore NuGet packages'
        inputs:
          command: 'restore'
          projects: '$(projectPath)'
        continueOnError: false

      - task: DotNetCoreCLI@2
        displayName: 'Build solution'
        inputs:
          command: 'build'
          projects: '$(projectPath)'
          arguments: '--configuration $(buildConfiguration) --no-restore'

      - task: DotNetCoreCLI@2
        displayName: 'Run unit tests'
        inputs:
          command: 'test'
          projects: '**/*Tests.csproj'
          arguments: '--configuration $(buildConfiguration) --no-build --verbosity normal --collect:"XPlat Code Coverage"'

      - task: DotNetCoreCLI@2
        displayName: 'Publish application'
        inputs:
          command: 'publish'
          projects: '$(projectPath)'
          arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/publish'
          zipAfterPublish: true
          modifyOutputPath: false

      - bash: |
          echo "Build completed successfully"
          echo "Configuration: $(buildConfiguration)"
          echo "Output directory: $(Build.ArtifactStagingDirectory)"
        displayName: 'Build summary'
        env:
          BUILD_CONFIG: $(buildConfiguration)
